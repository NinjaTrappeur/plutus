<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | This module assigns types to built-ins.</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- See the @plutus/language-plutus-core/docs/Constant application.md@</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- article for how this emerged.</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE GADTs                     #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings         #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusCore.Constant.Typed</span><span>
</span><a name="line-11"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSized"><span class="hs-identifier hs-type">BuiltinSized</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#SizeEntry"><span class="hs-identifier hs-type">SizeEntry</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinType"><span class="hs-identifier hs-type">BuiltinType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier hs-type">TypedBuiltinValue</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinName"><span class="hs-identifier hs-type">TypedBuiltinName</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeaning"><span class="hs-identifier hs-type">DynamicBuiltinNameMeaning</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameDefinition"><span class="hs-identifier hs-type">DynamicBuiltinNameDefinition</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeanings"><span class="hs-identifier hs-type">DynamicBuiltinNameMeanings</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span>
</span><a name="line-23"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluate"><span class="hs-identifier hs-type">Evaluate</span></a><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#KnownDynamicBuiltinType"><span class="hs-identifier hs-type">KnownDynamicBuiltinType</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#eraseTypedBuiltinSized"><span class="hs-identifier hs-var">eraseTypedBuiltinSized</span></a><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#runEvaluate"><span class="hs-identifier hs-var">runEvaluate</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#withEvaluator"><span class="hs-identifier hs-var">withEvaluator</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#readDynamicBuiltinM"><span class="hs-identifier hs-var">readDynamicBuiltinM</span></a><span>
</span><a name="line-29"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Constant.Dynamic.Pretty.html"><span class="hs-identifier">Language.PlutusCore.Constant.Dynamic.Pretty</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Evaluation.Result.html"><span class="hs-identifier">Language.PlutusCore.Evaluation.Result</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Lexer.Type.html"><span class="hs-identifier">Language.PlutusCore.Lexer.Type</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Name.html"><span class="hs-identifier">Language.PlutusCore.Name</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Pretty.html"><span class="hs-identifier">Language.PlutusCore.Pretty</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Quote.html"><span class="hs-identifier">Language.PlutusCore.Quote</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.StdLib.Data.Unit.html"><span class="hs-identifier">Language.PlutusCore.StdLib.Data.Unit</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Type.html"><span class="hs-identifier">Language.PlutusCore.Type</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy.Char8</span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSL</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.GADT.Compare</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Map</span><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">9</span><span> </span><span class="hs-special">`</span><a name="TypeSchemeArrow"><a href="Language.PlutusCore.Constant.Typed.html#TypeSchemeArrow"><span class="hs-identifier">TypeSchemeArrow</span></a></a><span class="hs-special">`</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">-- | Built-in types indexed by @size@.</span><span>
</span><a name="line-49"></a><span class="hs-keyword">data</span><span> </span><a name="BuiltinSized"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSized"><span class="hs-identifier">BuiltinSized</span></a></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="BuiltinSizedInt"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedInt"><span class="hs-identifier">BuiltinSizedInt</span></a></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BuiltinSizedBS"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedBS"><span class="hs-identifier">BuiltinSizedBS</span></a></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BuiltinSizedSize"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedSize"><span class="hs-identifier">BuiltinSizedSize</span></a></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-- | Built-in types indexed by @size@ along with their denotation.</span><span>
</span><a name="line-56"></a><span class="hs-keyword">data</span><span> </span><a name="TypedBuiltinSized"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier">TypedBuiltinSized</span></a></a><span> </span><a name="local-6989586621679467529"><a href="#local-6989586621679467529"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-57"></a><span>    </span><a name="TypedBuiltinSizedInt"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedInt"><span class="hs-identifier">TypedBuiltinSizedInt</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-58"></a><span>    </span><a name="TypedBuiltinSizedBS"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedBS"><span class="hs-identifier">TypedBuiltinSizedBS</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><span class="hs-identifier hs-type">BSL.ByteString</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-comment">-- See Note [Semantics of sizes].</span><span>
</span><a name="line-60"></a><span>    </span><a name="TypedBuiltinSizedSize"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedSize"><span class="hs-identifier">TypedBuiltinSizedSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">{- Note [Semantics of sizes]
We convert each PLC's @size s@ into Haskell's '()'. I.e. sizes are completely ignored in
the semantics of various built-ins. Hence the Haskell's type signature of PLC's 'resizeInteger' is

    () -&gt; Integer -&gt; Integer

while its PLC signature is

    forall s0 s1. size s1 -&gt; integer s0 -&gt; integer s1

This does not mean that we do not perform all the checks prescribed by the specification.
Merely that we can't compute using sizes on the Haskell side, e.g. we cannot assign a semantics to

    maxIntegerOfGivenSize : forall s. size s -&gt; integer s

There are two reasons for that:

1. Clarity. We want to be clear that size checks are not handled by Haskell interpretations of
   Plutus Core built-ins -- they're handled separately (see the &quot;Apply&quot; module).
   The reason for that is that we do not basically care what an operation do w.r.t. to sizes,
   we only care whether something it returns fits into some expected size.
   And this last checking step can be performed uniformly for all currently presented built-ins.

2. The semantics of @integer s@ is 'Integer'. While this may look ok, we actually lose size information,
   so e.g. there is no meaningful way we could interpret

       sizeOfInteger : forall s. integer s -&gt; size s

   with @size s@ being interpreted as 'Size', because in @Integer -&gt; Size@ the size of the 'Integer'
   is not specified. And we can't compute it, because we want its actual runtime size rather than
   the minimal size it fits into, as the former can be larger than the latter.
   Hence the semantics we have is

       sizeOfIntegerMeaning :: Integer -&gt; ()

   I.e. this doesn't do anything useful at all. But it's not supposed to,
   since it returns a size and sizes are handled separately as (1) describes.
-}</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- | Type-level sizes.</span><span>
</span><a name="line-102"></a><span class="hs-keyword">data</span><span> </span><a name="SizeEntry"><a href="Language.PlutusCore.Constant.Typed.html#SizeEntry"><span class="hs-identifier">SizeEntry</span></a></a><span> </span><a name="local-6989586621679467528"><a href="#local-6989586621679467528"><span class="hs-identifier">size</span></a></a><span>
</span><a name="line-103"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="SizeValue"><a href="Language.PlutusCore.Constant.Typed.html#SizeValue"><span class="hs-identifier">SizeValue</span></a></a><span> </span><a href="Language.PlutusCore.Type.html#Size"><span class="hs-identifier hs-type">Size</span></a><span>  </span><span class="hs-comment">-- ^ A constant size.</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SizeBound"><a href="Language.PlutusCore.Constant.Typed.html#SizeBound"><span class="hs-identifier">SizeBound</span></a></a><span> </span><a href="#local-6989586621679467528"><span class="hs-identifier hs-type">size</span></a><span>  </span><span class="hs-comment">-- ^ A bound size variable.</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- We write @SizeEntry Size@ sometimes, so this data type is not perfect, but it works fine.</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | Built-in types.</span><span>
</span><a name="line-109"></a><span class="hs-keyword">data</span><span> </span><a name="BuiltinType"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinType"><span class="hs-identifier">BuiltinType</span></a></a><span> </span><a name="local-6989586621679467527"><a href="#local-6989586621679467527"><span class="hs-identifier">size</span></a></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="BuiltinSized"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSized"><span class="hs-identifier">BuiltinSized</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#SizeEntry"><span class="hs-identifier hs-type">SizeEntry</span></a><span> </span><a href="#local-6989586621679467527"><span class="hs-identifier hs-type">size</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSized"><span class="hs-identifier hs-type">BuiltinSized</span></a><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BuiltinBool"><a href="Language.PlutusCore.Constant.Typed.html#BuiltinBool"><span class="hs-identifier">BuiltinBool</span></a></a><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- | Built-in types. A type is considired &quot;built-in&quot; if it can appear in the type signature</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- of a primitive operation. So @boolean@ is considered built-in even though it is defined in PLC</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- and is not primitive.</span><span>
</span><a name="line-116"></a><span class="hs-keyword">data</span><span> </span><a name="TypedBuiltin"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier">TypedBuiltin</span></a></a><span> </span><a name="local-6989586621679467520"><a href="#local-6989586621679467520"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621679467521"><a href="#local-6989586621679467521"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-117"></a><span>    </span><a name="TypedBuiltinSized"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier">TypedBuiltinSized</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#SizeEntry"><span class="hs-identifier hs-type">SizeEntry</span></a><span> </span><a href="#local-6989586621679467522"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><a href="#local-6989586621679467523"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467522"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467523"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-118"></a><span>    </span><span class="hs-comment">-- TODO: this is now more or less obsolete and should be removed,</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-comment">-- because 'TypedBuiltinDyn' is enough.</span><span>
</span><a name="line-120"></a><span>    </span><a name="TypedBuiltinBool"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier">TypedBuiltinBool</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467524"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-121"></a><span>    </span><span class="hs-comment">-- Any type that implements 'KnownDynamicBuiltinType' can be lifted to a 'TypedBuiltin',</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-comment">-- because any such type has a PLC representation and provides conversions back and forth</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-comment">-- between Haskell and PLC and that's all we need.</span><span>
</span><a name="line-124"></a><span>    </span><a name="TypedBuiltinDyn"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier">TypedBuiltinDyn</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#KnownDynamicBuiltinType"><span class="hs-identifier hs-type">KnownDynamicBuiltinType</span></a><span> </span><a href="#local-6989586621679467525"><span class="hs-identifier hs-type">dyn</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467526"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467525"><span class="hs-identifier hs-type">dyn</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- | A 'TypedBuiltin' packaged together with a value of the type that the 'TypedBuiltin' denotes.</span><span>
</span><a name="line-127"></a><span class="hs-keyword">data</span><span> </span><a name="TypedBuiltinValue"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier">TypedBuiltinValue</span></a></a><span> </span><a name="local-6989586621679467518"><a href="#local-6989586621679467518"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621679467519"><a href="#local-6989586621679467519"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TypedBuiltinValue"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier">TypedBuiltinValue</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467518"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467519"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679467519"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-comment">-- | Type schemes of primitive operations.</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- @a@ is the Haskell denotation of a PLC type represented as a 'TypeScheme'.</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- @r@ is the resulting type in @a@, e.g. the resulting type in</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- @ByteString -&gt; Size -&gt; Integer@ is @Integer@.</span><span>
</span><a name="line-133"></a><span class="hs-keyword">data</span><span> </span><a name="TypeScheme"><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier">TypeScheme</span></a></a><span> </span><a name="local-6989586621679467505"><a href="#local-6989586621679467505"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621679467506"><a href="#local-6989586621679467506"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679467507"><a href="#local-6989586621679467507"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-134"></a><span>    </span><a name="TypeSchemeBuiltin"><a href="Language.PlutusCore.Constant.Typed.html#TypeSchemeBuiltin"><span class="hs-identifier">TypeSchemeBuiltin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467508"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467509"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467508"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467509"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467509"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-135"></a><span>    </span><a name="TypeSchemeArrow"><a href="Language.PlutusCore.Constant.Typed.html#TypeSchemeArrow"><span class="hs-identifier">TypeSchemeArrow</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467510"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467511"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467512"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467510"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467513"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679467514"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467510"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679467511"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679467513"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679467514"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-136"></a><span>    </span><a name="TypeSchemeAllSize"><a href="Language.PlutusCore.Constant.Typed.html#TypeSchemeAllSize"><span class="hs-identifier">TypeSchemeAllSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679467515"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467515"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467516"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467517"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467515"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467516"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467517"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-137"></a><span>    </span><span class="hs-comment">-- This is nailed to @size@ rather than being a generic @TypeSchemeForall@ for simplicity</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-comment">-- and because at the moment we do not need anything else.</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-comment">-- We can make this generic by parametrising @TypeScheme@ by an</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-comment">-- @f :: Kind () -&gt; *@ rather than @size@.</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-comment">-- The @r@ is rather ad hoc and needed only for tests.</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-comment">-- We could use type families to compute it instead of storing as an index.</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-comment">-- That's a TODO perhaps.</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">-- | A 'BuiltinName' with an associated 'TypeScheme'.</span><span>
</span><a name="line-147"></a><span class="hs-keyword">data</span><span> </span><a name="TypedBuiltinName"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinName"><span class="hs-identifier">TypedBuiltinName</span></a></a><span> </span><a name="local-6989586621679467502"><a href="#local-6989586621679467502"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679467503"><a href="#local-6989586621679467503"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TypedBuiltinName"><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinName"><span class="hs-identifier">TypedBuiltinName</span></a></a><span> </span><a href="Language.PlutusCore.Lexer.Type.html#BuiltinName"><span class="hs-identifier hs-type">BuiltinName</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679467504"><a href="#local-6989586621679467504"><span class="hs-identifier">size</span></a></a><span class="hs-operator">.</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467504"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467502"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467503"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- I attempted to unify various typed things, but sometimes type variables must be universally</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- quantified, sometimes they must be existentially quatified. And those are distinct type variables.</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- | Convert a 'TypedBuiltinSized' to its untyped counterpart.</span><span>
</span><a name="line-152"></a><span class="hs-identifier">eraseTypedBuiltinSized</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><a href="#local-6989586621679467563"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSized"><span class="hs-identifier hs-type">BuiltinSized</span></a><span>
</span><a name="line-153"></a><a name="eraseTypedBuiltinSized"><a href="Language.PlutusCore.Constant.Typed.html#eraseTypedBuiltinSized"><span class="hs-identifier">eraseTypedBuiltinSized</span></a></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedInt"><span class="hs-identifier hs-var">TypedBuiltinSizedInt</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedInt"><span class="hs-identifier hs-var">BuiltinSizedInt</span></a><span>
</span><a name="line-154"></a><span class="hs-identifier">eraseTypedBuiltinSized</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedBS"><span class="hs-identifier hs-var">TypedBuiltinSizedBS</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedBS"><span class="hs-identifier hs-var">BuiltinSizedBS</span></a><span>
</span><a name="line-155"></a><span class="hs-identifier">eraseTypedBuiltinSized</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedSize"><span class="hs-identifier hs-var">TypedBuiltinSizedSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedSize"><span class="hs-identifier hs-var">BuiltinSizedSize</span></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-comment">{- Note [DynamicBuiltinNameMeaning]
We represent the meaning of a 'DynamicBuiltinName' as a 'TypeScheme' and a Haskell denotation.
We need both while evaluting a 'DynamicBuiltinName', because 'TypeScheme' is required for
well-typedness to avoid using 'unsafeCoerce' and similar junk, while the denotation is what
actually computes. We do not need denotations for type checking, nor strongly typed 'TypeScheme'
is required, however analogously to static built-ins, we compute the types of dynamic built-ins from
their 'TypeScheme's. This way we only define a 'TypeScheme', which we anyway need, and then compute
the corresponding 'Type' from it. And we can't go the other way around -- from untyped to typed --
of course. Therefore a typed thing has to go before the corresponding untyped thing and in the
final pipeline one has to supply a 'DynamicBuiltinNameMeaning' for each of the 'DynamicBuiltinName's.
-}</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- | The meaning of a dynamic built-in name consists of its 'Type' represented as a 'TypeScheme'</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- and its Haskell denotation.</span><span>
</span><a name="line-171"></a><span class="hs-keyword">data</span><span> </span><a name="DynamicBuiltinNameMeaning"><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeaning"><span class="hs-identifier">DynamicBuiltinNameMeaning</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679467499"><a href="#local-6989586621679467499"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679467500"><a href="#local-6989586621679467500"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span> </span><a name="DynamicBuiltinNameMeaning"><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeaning"><span class="hs-identifier">DynamicBuiltinNameMeaning</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679467501"><a href="#local-6989586621679467501"><span class="hs-identifier">size</span></a></a><span class="hs-operator">.</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a><span> </span><a href="#local-6989586621679467501"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467499"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467500"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679467499"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-173"></a><span class="hs-comment">-- See the [DynamicBuiltinNameMeaning] note.</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">-- | The definition of a dynamic built-in consists of its name and meaning.</span><span>
</span><a name="line-176"></a><span class="hs-keyword">data</span><span> </span><a name="DynamicBuiltinNameDefinition"><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameDefinition"><span class="hs-identifier">DynamicBuiltinNameDefinition</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-177"></a><span>    </span><a name="DynamicBuiltinNameDefinition"><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameDefinition"><span class="hs-identifier">DynamicBuiltinNameDefinition</span></a></a><span> </span><a href="Language.PlutusCore.Lexer.Type.html#DynamicBuiltinName"><span class="hs-identifier hs-type">DynamicBuiltinName</span></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeaning"><span class="hs-identifier hs-type">DynamicBuiltinNameMeaning</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">-- | Mapping from 'DynamicBuiltinName's to their 'DynamicBuiltinNameMeaning's.</span><span>
</span><a name="line-180"></a><span class="hs-keyword">newtype</span><span> </span><a name="DynamicBuiltinNameMeanings"><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeanings"><span class="hs-identifier">DynamicBuiltinNameMeanings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DynamicBuiltinNameMeanings"><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeanings"><span class="hs-identifier">DynamicBuiltinNameMeanings</span></a></a><span>
</span><a name="line-181"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="unDynamicBuiltinNameMeanings"><a href="Language.PlutusCore.Constant.Typed.html#unDynamicBuiltinNameMeanings"><span class="hs-identifier">unDynamicBuiltinNameMeanings</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Language.PlutusCore.Lexer.Type.html#DynamicBuiltinName"><span class="hs-identifier hs-type">DynamicBuiltinName</span></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeaning"><span class="hs-identifier hs-type">DynamicBuiltinNameMeaning</span></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Semigroup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-keyword">type</span><span> </span><a name="Evaluator"><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier">Evaluator</span></a></a><span> </span><a name="local-6989586621679467497"><a href="#local-6989586621679467497"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679467498"><a href="#local-6989586621679467498"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#DynamicBuiltinNameMeanings"><span class="hs-identifier hs-type">DynamicBuiltinNameMeanings</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679467497"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679467498"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusCore.Evaluation.Result.html#EvaluationResult"><span class="hs-identifier hs-type">EvaluationResult</span></a><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-keyword">type</span><span> </span><a name="Evaluate"><a href="Language.PlutusCore.Constant.Typed.html#Evaluate"><span class="hs-identifier">Evaluate</span></a></a><span> </span><a name="local-6989586621679467496"><a href="#local-6989586621679467496"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679467496"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679467496"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">runEvaluate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679467561"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluate"><span class="hs-identifier hs-type">Evaluate</span></a><span> </span><a href="#local-6989586621679467561"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679467562"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679467561"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679467562"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-189"></a><a name="runEvaluate"><a href="Language.PlutusCore.Constant.Typed.html#runEvaluate"><span class="hs-identifier">runEvaluate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runReaderT</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-identifier">withEvaluator</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679467559"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679467559"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679467560"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluate"><span class="hs-identifier hs-type">Evaluate</span></a><span> </span><a href="#local-6989586621679467559"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679467560"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-192"></a><a name="withEvaluator"><a href="Language.PlutusCore.Constant.Typed.html#withEvaluator"><span class="hs-identifier">withEvaluator</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ReaderT</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-comment">{- Note [Semantics of dynamic built-in types]
We only allow dynamic built-in types that

1. can be represented using static types in PLC. For example Haskell's 'Char' can be represented as
@integer 4@ in PLC. This restriction makes the dynamic built-in types machinery somewhat similar to
type aliases in Haskell (defined via the @type@ keyword). The reason for this restriction is that
storing values of arbitrary types of a host language in the AST of a target language is commonly far
from being trivial, hence we do not support this right now, but we plan to figure out a way to allow
such extensions to the AST
2. are of kind @*@. Dynamic built-in types that are not of kind @*@ can be encoded via recursive
instances. For example:

    instance KnownDynamicBuiltinType dyn =&gt; KnownDynamicBuiltinType [dyn] where
        ...

This is due to the fact that we use Haskell classes to assign semantics to dynamic built-in types and
since it's anyway impossible to assign a meaning to an open PLC type, because you'd have to somehow
interpret free variables, we're only interested in closed PLC types and those can be handled by
recursive instances as shown above.

Since type classes are globally coherent by design, we also have global coherence for dynamic built-in
types for free. Any dynamic built-in type means the same thing regardless of the blockchain it's
added to. It may prove to be restrictive, but it's a good property to start with, because less things
can silently stab you in the back.

An @KnownDynamicBuiltinType dyn@ instance provides

1. a way to encode @dyn@ as a PLC type ('getTypeEncoding')
2. a function that encodes values of type @dyn@ as PLC terms ('makeDynamicBuiltin')
3. a function that decodes PLC terms back to Haskell values ('readDynamicBuiltin')

The last two are ought to constitute an isomorphism (modulo 'Quote' and 'Maybe').
-}</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">{- Note [Converting PLC values to Haskell values]
The first thought that comes to mind when you asked to convert a PLC value to the corresponding Haskell
value is &quot;just match on the AST&quot;. This works nicely for simple things like 'Char's which we encode as
@integer@s, see the @KnownDynamicBuiltinType Char@ instance below.

But how to convert something more complicated like lists? A PLC list gets passed as argument to
a built-in after it gets evaluated to WHNF. We can't just match on the AST here, because after
the initial lambda it can be anything there: function applications, other built-ins, recursive data,
anything. &quot;Well, just normalize it&quot; -- not so fast: for one, we did not have a term normalization
procedure at the moment this note was written, for two, it's not something that can be easily done,
because you have to carefully handle uniques (we generate new terms during evaluation) and perform type
substitutions, because types must be preserved.

Besides, matching on the AST becomes really complicated: you have to ensure that a term does have
an expected semantics by looking at the term's syntax. Huge pattern matches followed by multiple
checks that variables have equal names in right places and have distinct names otherwise. Making a
mistake is absolutely trivial here. Of course, one could just omit checks and hope it'll work alright,
but eventually it'll break and debugging won't be fun at all.

So instead of dealing with syntax of terms, we deal with their semantics. Namely, we evaluate terms
using some evaluator (normally, the CEK machine). For the temporary lack of ability to put values of
arbitrary Haskell types into the Plutus Core AST, we convert PLC values to Haskell values and &quot;emit&quot;
the latter via a combination of 'unsafePerformIO' and 'IORef'. For example, we fold a PLC list with
a dynamic built-in name (called `emit`) that calls 'unsafePerformIO' over a Haskell function that
appends an element to the list stored in an 'IORef':

    plcListToHaskellList list =
        evaluateCek anEnvironment (foldList {dyn} {unit} (\(r : unit) -&gt; emit) unitval list)

After evaluation finishes, we read a Haskell list from the 'IORef'
(which requires another 'unsafePerformIO') and return it.
-}</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-comment">{- Note [Evaluators]
A dynamic built-in name can be applied to something that contains uninstantiated variables. There are
several possible ways to handle that:

1. each evaluator is required to perform substitutions to instantiate all variables in arguments to
built-ins. The drawback is that this can be inefficient in cases when there are many applications of
built-ins and arguments are of non-primitive types. Besides, substitution is tricky and is trivial to
screw up
2. we can break encapsulation and pass environments to the built-ins application machinery, so that it
knows how to instantiate variables. This would work for the strict CEK machine, but the lazy
CEK machine also has a heap and there can be other evaluators that have their internal state that
can't just be thrown away and it's impossible for the built-ins application machinery to handle states
of all possible evaluators beforehand
3. or we can just require to pass the current evaluator with its encapsulated state to functions that
evaluate built-in applications. The type of evaluators is this then:

    type Evaluator f = DynamicBuiltinNameMeanings -&gt; f TyName Name () -&gt; EvaluationResult

so @Evaluator Term@ receives a map with meanings of dynamic built-in names which extends the map the
evaluator already has (this is needed, because we add new dynamic built-in names during conversion of
PLC values to Haskell values, see Note [Converting PLC values to Haskell values]), a 'Term' to evaluate
and returns an 'EvaluationResult' (we may want to later add handling of errors here). Thus, whenever
we want to resume evaluation during computation of a dynamic built-in application, we just call the
received evaluator

(3) seems best, so it's what is implemented.
-}</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-comment">-- See Note [Semantics of dynamic built-in types].</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- See Note [Converting PLC values to Haskell values].</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- | Haskell types known to exist on the PLC side.</span><span>
</span><a name="line-292"></a><span class="hs-keyword">class</span><span> </span><a name="KnownDynamicBuiltinType"><a href="Language.PlutusCore.Constant.Typed.html#KnownDynamicBuiltinType"><span class="hs-identifier">KnownDynamicBuiltinType</span></a></a><span> </span><a name="local-6989586621679467493"><a href="#local-6989586621679467493"><span class="hs-identifier">dyn</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-comment">-- | The type representing @dyn@ used on the PLC side.</span><span>
</span><a name="line-294"></a><span>    </span><a name="getTypeEncoding"><a href="Language.PlutusCore.Constant.Typed.html#getTypeEncoding"><span class="hs-identifier">getTypeEncoding</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679467494"><span class="hs-identifier hs-type">proxy</span></a><span> </span><a href="#local-6989586621679467493"><span class="hs-identifier hs-type">dyn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>    </span><span class="hs-comment">-- | Convert a Haskell value to the corresponding PLC value.</span><span>
</span><a name="line-297"></a><span>    </span><span class="hs-comment">-- 'Nothing' represents a conversion failure.</span><span>
</span><a name="line-298"></a><span>    </span><a name="makeDynamicBuiltin"><a href="Language.PlutusCore.Constant.Typed.html#makeDynamicBuiltin"><span class="hs-identifier">makeDynamicBuiltin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679467493"><span class="hs-identifier hs-type">dyn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span>    </span><span class="hs-comment">-- See Note [Evaluators].</span><span>
</span><a name="line-301"></a><span>    </span><span class="hs-comment">-- | Convert a PLC value to the corresponding Haskell value.</span><span>
</span><a name="line-302"></a><span>    </span><span class="hs-comment">-- 'Nothing' represents a conversion failure.</span><span>
</span><a name="line-303"></a><span>    </span><a name="readDynamicBuiltin"><a href="Language.PlutusCore.Constant.Typed.html#readDynamicBuiltin"><span class="hs-identifier">readDynamicBuiltin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679467495"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluator"><span class="hs-identifier hs-type">Evaluator</span></a><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="#local-6989586621679467495"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679467495"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679467493"><span class="hs-identifier hs-type">dyn</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">readDynamicBuiltinM</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#KnownDynamicBuiltinType"><span class="hs-identifier hs-type">KnownDynamicBuiltinType</span></a><span> </span><a href="#local-6989586621679467558"><span class="hs-identifier hs-type">dyn</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#Evaluate"><span class="hs-identifier hs-type">Evaluate</span></a><span> </span><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679467558"><span class="hs-identifier hs-type">dyn</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><a name="readDynamicBuiltinM"><a href="Language.PlutusCore.Constant.Typed.html#readDynamicBuiltinM"><span class="hs-identifier">readDynamicBuiltinM</span></a></a><span> </span><a name="local-6989586621679467564"><a href="#local-6989586621679467564"><span class="hs-identifier">term</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#withEvaluator"><span class="hs-identifier hs-var">withEvaluator</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679467565"><a href="#local-6989586621679467565"><span class="hs-identifier">eval</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#readDynamicBuiltin"><span class="hs-identifier hs-var">readDynamicBuiltin</span></a><span> </span><a href="#local-6989586621679467565"><span class="hs-identifier hs-var">eval</span></a><span> </span><a href="#local-6989586621679467564"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSized"><span class="hs-identifier hs-type">BuiltinSized</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-311"></a><span>    </span><a name="local-8214565720323803316"><span class="hs-identifier">pretty</span></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedInt"><span class="hs-identifier hs-var">BuiltinSizedInt</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;integer&quot;</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedBS"><span class="hs-identifier hs-var">BuiltinSizedBS</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;bytestring&quot;</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#BuiltinSizedSize"><span class="hs-identifier hs-var">BuiltinSizedSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;size&quot;</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><a href="#local-6989586621679467554"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-316"></a><span>    </span><a name="local-8214565720323803316"><span class="hs-identifier">pretty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#eraseTypedBuiltinSized"><span class="hs-identifier hs-var">eraseTypedBuiltinSized</span></a><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><a href="#local-6989586621679467551"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#SizeEntry"><span class="hs-identifier hs-type">SizeEntry</span></a><span> </span><a href="#local-6989586621679467551"><span class="hs-identifier hs-type">size</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-319"></a><span>    </span><a name="local-8214565720323803316"><span class="hs-identifier">pretty</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#SizeValue"><span class="hs-identifier hs-var">SizeValue</span></a><span> </span><a name="local-6989586621679467552"><a href="#local-6989586621679467552"><span class="hs-identifier">size</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621679467552"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-320"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#SizeBound"><span class="hs-identifier hs-var">SizeBound</span></a><span> </span><a name="local-6989586621679467553"><a href="#local-6989586621679467553"><span class="hs-identifier">size</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621679467553"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><a href="#local-6989586621679467546"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467546"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467547"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-323"></a><span>    </span><a name="local-8214565720323803316"><span class="hs-identifier">pretty</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><a name="local-6989586621679467548"><a href="#local-6989586621679467548"><span class="hs-identifier">se</span></a></a><span> </span><a name="local-6989586621679467549"><a href="#local-6989586621679467549"><span class="hs-identifier">tbs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621679467549"><span class="hs-identifier hs-var">tbs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621679467548"><span class="hs-identifier hs-var">se</span></a><span>
</span><a name="line-324"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;bool&quot;</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-comment">-- Do we want this entire thing to be 'PrettyBy' rather than 'Pretty'?</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-comment">-- This is just used in errors, so we probably do not care much.</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><a name="local-6989586621679467550"><a href="#local-6989586621679467550"><span class="hs-identifier">dyn</span></a></a><span class="hs-glyph">@</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Pretty.html#prettyPlcDef"><span class="hs-identifier hs-var">prettyPlcDef</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Quote.html#runQuote"><span class="hs-identifier hs-var">runQuote</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#getTypeEncoding"><span class="hs-identifier hs-var">getTypeEncoding</span></a><span> </span><a href="#local-6989586621679467550"><span class="hs-identifier hs-var">dyn</span></a><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">size</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Language.PlutusCore.Type.html#Size"><span class="hs-identifier hs-type">Size</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.Pretty.html#PrettyDynamic"><span class="hs-identifier hs-type">PrettyDynamic</span></a><span> </span><a href="#local-6989586621679467541"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier hs-type">TypedBuiltinValue</span></a><span> </span><a href="#local-6989586621679467540"><span class="hs-identifier hs-type">size</span></a><span> </span><a href="#local-6989586621679467541"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-330"></a><span>    </span><a name="local-8214565720323803316"><span class="hs-identifier">pretty</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier hs-var">TypedBuiltinValue</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><a name="local-6989586621679467542"><a href="#local-6989586621679467542"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679467543"><a href="#local-6989586621679467543"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621679467542"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-string">&quot;!&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.Pretty.html#prettyDynamic"><span class="hs-identifier hs-var">prettyDynamic</span></a><span> </span><a href="#local-6989586621679467543"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-331"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier hs-var">TypedBuiltinValue</span></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>         </span><a name="local-6989586621679467544"><a href="#local-6989586621679467544"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.Pretty.html#prettyDynamic"><span class="hs-identifier hs-var">prettyDynamic</span></a><span> </span><a href="#local-6989586621679467544"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-identifier">pretty</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinValue"><span class="hs-identifier hs-var">TypedBuiltinValue</span></a><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>          </span><a name="local-6989586621679467545"><a href="#local-6989586621679467545"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Dynamic.Pretty.html#prettyDynamic"><span class="hs-identifier hs-var">prettyDynamic</span></a><span> </span><a href="#local-6989586621679467545"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-identifier">liftOrdering</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GOrdering</span><span> </span><a href="#local-6989586621679467556"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679467556"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-335"></a><a name="liftOrdering"><a href="Language.PlutusCore.Constant.Typed.html#liftOrdering"><span class="hs-identifier">liftOrdering</span></a></a><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GLT</span><span>
</span><a name="line-336"></a><span class="hs-identifier">liftOrdering</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GEQ</span><span>
</span><a name="line-337"></a><span class="hs-identifier">liftOrdering</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GGT</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-comment">-- I tried using the 'dependent-sum-template' package,</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- but see https://stackoverflow.com/q/50048842/3237465</span><span>
</span><a name="line-341"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">GEq</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-type">TypedBuiltinSized</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-342"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedInt"><span class="hs-identifier hs-var">TypedBuiltinSizedInt</span></a><span>  </span><span class="hs-special">`</span><a name="local-8214565720324242184"><span class="hs-identifier">geq</span></a><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedInt"><span class="hs-identifier hs-var">TypedBuiltinSizedInt</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span>
</span><a name="line-343"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedBS"><span class="hs-identifier hs-var">TypedBuiltinSizedBS</span></a><span>   </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedBS"><span class="hs-identifier hs-var">TypedBuiltinSizedBS</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span>
</span><a name="line-344"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedSize"><span class="hs-identifier hs-var">TypedBuiltinSizedSize</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedSize"><span class="hs-identifier hs-var">TypedBuiltinSizedSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span>
</span><a name="line-345"></a><span>    </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-identifier">comparedDynamicBuiltinTypesError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679467555"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-348"></a><a name="comparedDynamicBuiltinTypesError"><a href="Language.PlutusCore.Constant.Typed.html#comparedDynamicBuiltinTypesError"><span class="hs-identifier">comparedDynamicBuiltinTypesError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Dynamic built-in types cannot be compared&quot;</span><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679467535"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GEq</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467535"><span class="hs-identifier hs-type">size</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-351"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><a name="local-6989586621679467536"><a href="#local-6989586621679467536"><span class="hs-identifier">size1</span></a></a><span> </span><a name="local-6989586621679467537"><a href="#local-6989586621679467537"><span class="hs-identifier">tbs1</span></a></a><span> </span><span class="hs-special">`</span><a name="local-8214565720324242184"><span class="hs-identifier">geq</span></a><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><a name="local-6989586621679467538"><a href="#local-6989586621679467538"><span class="hs-identifier">size2</span></a></a><span> </span><a name="local-6989586621679467539"><a href="#local-6989586621679467539"><span class="hs-identifier">tbs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-352"></a><span>        </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679467536"><span class="hs-identifier hs-var">size1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679467538"><span class="hs-identifier hs-var">size2</span></a><span>
</span><a name="line-353"></a><span>        </span><a href="#local-6989586621679467537"><span class="hs-identifier hs-var">tbs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">geq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679467539"><span class="hs-identifier hs-var">tbs2</span></a><span>
</span><a name="line-354"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>             </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span>
</span><a name="line-355"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>              </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#comparedDynamicBuiltinTypesError"><span class="hs-identifier hs-var">comparedDynamicBuiltinTypesError</span></a><span>
</span><a name="line-356"></a><span>    </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#comparedDynamicBuiltinTypesError"><span class="hs-identifier hs-var">comparedDynamicBuiltinTypesError</span></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-special">`</span><span class="hs-identifier">geq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679467530"><span class="hs-identifier hs-type">size</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GCompare</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltin"><span class="hs-identifier hs-type">TypedBuiltin</span></a><span> </span><a href="#local-6989586621679467530"><span class="hs-identifier hs-type">size</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-360"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><a name="local-6989586621679467531"><a href="#local-6989586621679467531"><span class="hs-identifier">size1</span></a></a><span> </span><a name="local-6989586621679467532"><a href="#local-6989586621679467532"><span class="hs-identifier">tbs1</span></a></a><span> </span><span class="hs-special">`</span><a name="local-8214565720324242182"><span class="hs-identifier">gcompare</span></a><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><a name="local-6989586621679467533"><a href="#local-6989586621679467533"><span class="hs-identifier">size2</span></a></a><span> </span><a name="local-6989586621679467534"><a href="#local-6989586621679467534"><span class="hs-identifier">tbs2</span></a></a><span>
</span><a name="line-361"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679467532"><span class="hs-identifier hs-var">tbs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">geq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679467534"><span class="hs-identifier hs-var">tbs2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#liftOrdering"><span class="hs-identifier hs-var">liftOrdering</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679467531"><span class="hs-identifier hs-var">size1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679467533"><span class="hs-identifier hs-var">size2</span></a><span>
</span><a name="line-362"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679467532"><span class="hs-identifier hs-var">tbs1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679467534"><span class="hs-identifier hs-var">tbs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-363"></a><span>            </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedInt"><span class="hs-identifier hs-var">TypedBuiltinSizedInt</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GLT</span><span>
</span><a name="line-364"></a><span>            </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedBS"><span class="hs-identifier hs-var">TypedBuiltinSizedBS</span></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedInt"><span class="hs-identifier hs-var">TypedBuiltinSizedInt</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GGT</span><span>
</span><a name="line-365"></a><span>            </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedBS"><span class="hs-identifier hs-var">TypedBuiltinSizedBS</span></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GLT</span><span>
</span><a name="line-366"></a><span>            </span><span class="hs-special">(</span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSizedSize"><span class="hs-identifier hs-var">TypedBuiltinSizedSize</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GGT</span><span>
</span><a name="line-367"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>             </span><span class="hs-special">`</span><span class="hs-identifier">gcompare</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GEQ</span><span>
</span><a name="line-368"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-special">`</span><span class="hs-identifier">gcompare</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GLT</span><span>
</span><a name="line-369"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinBool"><span class="hs-identifier hs-var">TypedBuiltinBool</span></a><span>             </span><span class="hs-special">`</span><span class="hs-identifier">gcompare</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinSized"><span class="hs-identifier hs-var">TypedBuiltinSized</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GGT</span><span>
</span><a name="line-370"></a><span>    </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>              </span><span class="hs-special">`</span><span class="hs-identifier">gcompare</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#comparedDynamicBuiltinTypesError"><span class="hs-identifier hs-var">comparedDynamicBuiltinTypesError</span></a><span>
</span><a name="line-371"></a><span>    </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-special">`</span><span class="hs-identifier">gcompare</span><span class="hs-special">`</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#TypedBuiltinDyn"><span class="hs-identifier hs-var">TypedBuiltinDyn</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#comparedDynamicBuiltinTypesError"><span class="hs-identifier hs-var">comparedDynamicBuiltinTypesError</span></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-comment">-- Encode '()' from Haskell as @all r. r -&gt; r@ from PLC.</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- This is a very special instance, because it's used to define functions that are needed for</span><span>
</span><a name="line-375"></a><span class="hs-comment">-- other instances, so we keep it here.</span><span>
</span><a name="line-376"></a><span class="hs-keyword">instance</span><span> </span><a href="Language.PlutusCore.Constant.Typed.html#KnownDynamicBuiltinType"><span class="hs-identifier hs-type">KnownDynamicBuiltinType</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-377"></a><span>    </span><a name="local-8214565720324242360"><a href="Language.PlutusCore.Constant.Typed.html#getTypeEncoding"><span class="hs-identifier">getTypeEncoding</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.StdLib.Data.Unit.html#getBuiltinUnit"><span class="hs-identifier hs-var">getBuiltinUnit</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-comment">-- We need this matching, because otherwise Haskell expressions are thrown away rather than being</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-comment">-- evaluated and we use 'unsafePerformIO' in multiple places, so we want to compute the '()' just</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-comment">-- for side effects the evaluation may cause.</span><span>
</span><a name="line-382"></a><span>    </span><a name="local-8214565720324242361"><a href="Language.PlutusCore.Constant.Typed.html#makeDynamicBuiltin"><span class="hs-identifier">makeDynamicBuiltin</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusCore.StdLib.Data.Unit.html#getBuiltinUnitval"><span class="hs-identifier hs-var">getBuiltinUnitval</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>    </span><span class="hs-comment">-- We do not check here that the term is indeed @unitval@. TODO: check.</span><span>
</span><a name="line-385"></a><span>    </span><a name="local-8214565720324242362"><a href="Language.PlutusCore.Constant.Typed.html#readDynamicBuiltin"><span class="hs-identifier">readDynamicBuiltin</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a></pre></body></html>