<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes         #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusCore.TH</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.TH.html#plcTerm"><span class="hs-identifier hs-var">plcTerm</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.TH.html#plcType"><span class="hs-identifier hs-var">plcType</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusCore.TH.html#plcProgram"><span class="hs-identifier hs-var">plcProgram</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.Haskell.TH</span><span>        </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.Haskell.TH.Quote</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Error.html"><span class="hs-identifier">Language.PlutusCore.Error</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Lexer.html"><span class="hs-identifier">Language.PlutusCore.Lexer</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Name.html"><span class="hs-identifier">Language.PlutusCore.Name</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Parser.html"><span class="hs-identifier">Language.PlutusCore.Parser</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Pretty.html"><span class="hs-identifier">Language.PlutusCore.Pretty</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Quote.html"><span class="hs-identifier">Language.PlutusCore.Quote</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Subst.html"><span class="hs-identifier">Language.PlutusCore.Subst</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusCore.Type.html"><span class="hs-identifier">Language.PlutusCore.Type</span></a><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Except</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-comment">{-
This uses the approach in https://www.well-typed.com/blog/2014/10/quasi-quoting-dsls/ to use free
object-level variables as metavariables. This also means you can only construct closed terms, which
is what we want.
-}</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-comment">{- Note [Metavar map functions]
These functions are a little complicated: essentially, we need to reify the whole substitution map at
compile time. Sadly, TH isn't clever enough to do this automatically, so we manually create
the list of expressions, lift it to a quoted list, and then zip it back together with the
automatically lifted list of source expressions.

Also, although they're largely identical, we have two versions so we can put
explicit type annotations in the generated code, which makes the type errors if you get
things wrong much better.
-}</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-identifier">substs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">T.Text</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-45"></a><a name="substs"><a href="Language.PlutusCore.TH.html#substs"><span class="hs-identifier">substs</span></a></a><span> </span><a name="local-6989586621679539376"><a href="#local-6989586621679539376"><span class="hs-identifier">fvsL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679539377"><a href="#local-6989586621679539377"><span class="hs-identifier">substFun</span></a></a><span> </span><a name="local-6989586621679539378"><a href="#local-6989586621679539378"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.unpack</span><span> </span><a href="#local-6989586621679539378"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">|]</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">listE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679539377"><span class="hs-identifier hs-var">substFun</span></a><span> </span><a href="#local-6989586621679539376"><span class="hs-identifier hs-var">fvsL</span></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- See note [Metavar map functions]</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- | Get a quotation of a map between names and Haskell variable references to terms using the</span><span>
</span><a name="line-49"></a><span class="hs-comment">-- name as the variable name.</span><span>
</span><a name="line-50"></a><span class="hs-identifier">metavarMapTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><a href="#local-6989586621679539375"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-51"></a><a name="metavarMapTerm"><a href="Language.PlutusCore.TH.html#metavarMapTerm"><span class="hs-identifier">metavarMapTerm</span></a></a><span> </span><a name="local-6989586621679539380"><a href="#local-6989586621679539380"><span class="hs-identifier">ftvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679539381"><a href="#local-6989586621679539381"><span class="hs-identifier">ftvsL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nameString</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679539380"><span class="hs-identifier hs-var">ftvs</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">[|</span><span>
</span><a name="line-53"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-54"></a><span>            </span><span class="hs-identifier">subs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-55"></a><span>            </span><a name="local-6989586621679539382"><a href="#local-6989586621679539382"><span class="hs-identifier">subs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><a href="Language.PlutusCore.TH.html#substs"><span class="hs-identifier hs-var">substs</span></a><span> </span><a href="#local-6989586621679539381"><span class="hs-identifier hs-var">ftvsL</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>            </span><span class="hs-identifier">qm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>            </span><a name="local-6989586621679539383"><a href="#local-6989586621679539383"><span class="hs-identifier">qm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679539381"><span class="hs-identifier hs-var">ftvsL</span></a><span> </span><a href="#local-6989586621679539382"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679539383"><span class="hs-identifier hs-var">qm</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-special">|]</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">-- See note [Metavar map functions]</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Get a quotation of a map between type names and Haskell variable references to types using the</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- type name as the variable name.</span><span>
</span><a name="line-64"></a><span class="hs-identifier">metavarMapType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="#local-6989586621679539374"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-65"></a><a name="metavarMapType"><a href="Language.PlutusCore.TH.html#metavarMapType"><span class="hs-identifier">metavarMapType</span></a></a><span> </span><a name="local-6989586621679539385"><a href="#local-6989586621679539385"><span class="hs-identifier">ftvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679539386"><a href="#local-6989586621679539386"><span class="hs-identifier">ftvsL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nameString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unTyName</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679539385"><span class="hs-identifier hs-var">ftvs</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">[|</span><span>
</span><a name="line-67"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-68"></a><span>          </span><span class="hs-identifier">subs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-69"></a><span>          </span><a name="local-6989586621679539387"><a href="#local-6989586621679539387"><span class="hs-identifier">subs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><a href="Language.PlutusCore.TH.html#substs"><span class="hs-identifier hs-var">substs</span></a><span> </span><a href="#local-6989586621679539386"><span class="hs-identifier hs-var">ftvsL</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>          </span><span class="hs-identifier">qm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>          </span><a name="local-6989586621679539388"><a href="#local-6989586621679539388"><span class="hs-identifier">qm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679539386"><span class="hs-identifier hs-var">ftvsL</span></a><span> </span><a href="#local-6989586621679539387"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-72"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679539388"><span class="hs-identifier hs-var">qm</span></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-special">|]</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-identifier">metavarSubstType</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-76"></a><span>  </span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-78"></a><span>  </span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><a name="metavarSubstType"><a href="Language.PlutusCore.TH.html#metavarSubstType"><span class="hs-identifier">metavarSubstType</span></a></a><span> </span><a name="local-6989586621679539390"><a href="#local-6989586621679539390"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679539391"><a href="#local-6989586621679539391"><span class="hs-identifier">tyMetavars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span>
</span><a name="line-80"></a><span>                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679539392"><a href="#local-6989586621679539392"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unTyName</span><span> </span><a href="#local-6989586621679539392"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539391"><span class="hs-identifier hs-var">tyMetavars</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>                        </span><a href="#local-6989586621679539390"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-identifier">metavarSubstTerm</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-84"></a><span>  </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-87"></a><span>  </span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><a name="metavarSubstTerm"><a href="Language.PlutusCore.TH.html#metavarSubstTerm"><span class="hs-identifier">metavarSubstTerm</span></a></a><span> </span><a name="local-6989586621679539393"><a href="#local-6989586621679539393"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679539394"><a href="#local-6989586621679539394"><span class="hs-identifier">tyMetavars</span></a></a><span> </span><a name="local-6989586621679539395"><a href="#local-6989586621679539395"><span class="hs-identifier">termMetavars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.Subst.html#substTerm"><span class="hs-identifier hs-var">substTerm</span></a><span>
</span><a name="line-89"></a><span>                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679539396"><a href="#local-6989586621679539396"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unTyName</span><span> </span><a href="#local-6989586621679539396"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539394"><span class="hs-identifier hs-var">tyMetavars</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>                        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679539397"><a href="#local-6989586621679539397"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nameString</span><span> </span><a href="#local-6989586621679539397"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539395"><span class="hs-identifier hs-var">termMetavars</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>                        </span><a href="#local-6989586621679539393"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-comment">-- | Runs a 'QuoteT' in the 'Q' context. Note that this uses 'runQuoteT', so does note preserve freshness.</span><span>
</span><a name="line-94"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pretty</span><span> </span><a href="#local-6989586621679539372"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusCore.Quote.html#QuoteT"><span class="hs-identifier hs-type">QuoteT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Except</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Error.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="#local-6989586621679539372"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539373"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><a href="#local-6989586621679539373"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-95"></a><a name="eval"><a href="Language.PlutusCore.TH.html#eval"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679539398"><a href="#local-6989586621679539398"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">runExcept</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Quote.html#runQuoteT"><span class="hs-identifier hs-var">runQuoteT</span></a><span> </span><a href="#local-6989586621679539398"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679539399"><a href="#local-6989586621679539399"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Pretty.html#prettyPlcDefString"><span class="hs-identifier hs-var">prettyPlcDefString</span></a><span> </span><a href="#local-6989586621679539399"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679539400"><a href="#local-6989586621679539400"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679539400"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-identifier">unsafeDropErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679539370"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679539371"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679539371"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-100"></a><a name="unsafeDropErrors"><a href="Language.PlutusCore.TH.html#unsafeDropErrors"><span class="hs-identifier">unsafeDropErrors</span></a></a><span> </span><a name="local-6989586621679539401"><a href="#local-6989586621679539401"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679539401"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679539402"><a href="#local-6989586621679539402"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679539402"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Impossible!&quot;</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">{-- Note [Parsing and TH stages]
We have a bit of a dilemma with the staging and parsing of PLC. We need the list of metavars at compile time
so we can wire up the Haskell variable references, but we won't know the real variable names until runtime
(since we're running things in 'Quote'!).

The solution is kind of hacky, but works nicely: the linkage to metavar is done only by *name*, which does *not*
include the unique tag. So we can parse the quasiquote at compile time to get the metavars, and then *again*
at runtime to get the real program, and still be able to wire things up (since we're going to look for free vars at
runtime by name, ignoring uniques).

The runtime parse also assumes there will be no parse errors, since we've already checked, and there is nowhere
to put them.

Finally, we need to drop the lexer position annotations, since they're not terribly useful.
-}</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-identifier">compileTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-121"></a><a name="compileTerm"><a href="Language.PlutusCore.TH.html#compileTerm"><span class="hs-identifier">compileTerm</span></a></a><span> </span><a name="local-6989586621679539403"><a href="#local-6989586621679539403"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>    </span><a name="local-6989586621679539404"><a href="#local-6989586621679539404"><span class="hs-identifier">compileTimeT</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.TH.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Parser.html#parseTerm"><span class="hs-identifier hs-var">parseTerm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PlutusPrelude.html#strToBs"><span class="hs-identifier hs-var">strToBs</span></a><span> </span><a href="#local-6989586621679539403"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-123"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-124"></a><span>        </span><a name="local-6989586621679539405"><a href="#local-6989586621679539405"><span class="hs-identifier">tyMetavars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#metavarMapType"><span class="hs-identifier hs-var">metavarMapType</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Subst.html#ftvTerm"><span class="hs-identifier hs-var">ftvTerm</span></a><span> </span><a href="#local-6989586621679539404"><span class="hs-identifier hs-var">compileTimeT</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>        </span><a name="local-6989586621679539406"><a href="#local-6989586621679539406"><span class="hs-identifier">termMetavars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#metavarMapTerm"><span class="hs-identifier hs-var">metavarMapTerm</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Subst.html#fvTerm"><span class="hs-identifier hs-var">fvTerm</span></a><span> </span><a href="#local-6989586621679539404"><span class="hs-identifier hs-var">compileTimeT</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-special">[|</span><span>
</span><a name="line-127"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-128"></a><span>            </span><span class="hs-identifier">quoted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>            </span><a name="local-6989586621679539407"><a href="#local-6989586621679539407"><span class="hs-identifier">quoted</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>                </span><span class="hs-keyword">let</span><span>
</span><a name="line-131"></a><span>                    </span><span class="hs-comment">-- See note [Parsing and TH stages]</span><span>
</span><a name="line-132"></a><span>                    </span><span class="hs-identifier">parsed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Error.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="Language.PlutusCore.Lexer.html#AlexPosn"><span class="hs-identifier hs-type">AlexPosn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>                    </span><a name="local-6989586621679539408"><a href="#local-6989586621679539408"><span class="hs-identifier">parsed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Parser.html#parseTerm"><span class="hs-identifier hs-var">parseTerm</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="PlutusPrelude.html#strToBs"><span class="hs-identifier hs-var">strToBs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539403"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-134"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-135"></a><span>                    </span><a name="local-6989586621679539409"><a href="#local-6989586621679539409"><span class="hs-identifier">runtimeT</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.TH.html#unsafeDropErrors"><span class="hs-identifier hs-var">unsafeDropErrors</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679539408"><span class="hs-identifier hs-var">parsed</span></a><span>
</span><a name="line-136"></a><span>                    </span><a href="Language.PlutusCore.TH.html#metavarSubstTerm"><span class="hs-identifier hs-var">metavarSubstTerm</span></a><span> </span><a href="#local-6989586621679539409"><span class="hs-identifier hs-var">runtimeT</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679539405"><span class="hs-identifier hs-var">tyMetavars</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679539406"><span class="hs-identifier hs-var">termMetavars</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679539407"><span class="hs-identifier hs-var">quoted</span></a><span>
</span><a name="line-138"></a><span>     </span><span class="hs-special">|]</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-identifier">compileType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-141"></a><a name="compileType"><a href="Language.PlutusCore.TH.html#compileType"><span class="hs-identifier">compileType</span></a></a><span> </span><a name="local-6989586621679539412"><a href="#local-6989586621679539412"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>    </span><a name="local-6989586621679539413"><a href="#local-6989586621679539413"><span class="hs-identifier">compileTimeTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.TH.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Parser.html#parseType"><span class="hs-identifier hs-var">parseType</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PlutusPrelude.html#strToBs"><span class="hs-identifier hs-var">strToBs</span></a><span> </span><a href="#local-6989586621679539412"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-144"></a><span>        </span><a name="local-6989586621679539414"><a href="#local-6989586621679539414"><span class="hs-identifier">tyMetavars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#metavarMapType"><span class="hs-identifier hs-var">metavarMapType</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Subst.html#ftvTy"><span class="hs-identifier hs-var">ftvTy</span></a><span> </span><a href="#local-6989586621679539413"><span class="hs-identifier hs-var">compileTimeTy</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-special">[|</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-147"></a><span>            </span><span class="hs-identifier">quoted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>            </span><a name="local-6989586621679539415"><a href="#local-6989586621679539415"><span class="hs-identifier">quoted</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-149"></a><span>                </span><span class="hs-keyword">let</span><span>
</span><a name="line-150"></a><span>                    </span><span class="hs-comment">-- See note [Parsing and TH stages]</span><span>
</span><a name="line-151"></a><span>                    </span><span class="hs-identifier">parsed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Error.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="Language.PlutusCore.Lexer.html#AlexPosn"><span class="hs-identifier hs-type">AlexPosn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>                    </span><a name="local-6989586621679539416"><a href="#local-6989586621679539416"><span class="hs-identifier">parsed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Parser.html#parseType"><span class="hs-identifier hs-var">parseType</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="PlutusPrelude.html#strToBs"><span class="hs-identifier hs-var">strToBs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539412"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-153"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-154"></a><span>                    </span><a name="local-6989586621679539417"><a href="#local-6989586621679539417"><span class="hs-identifier">runtimeTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.TH.html#unsafeDropErrors"><span class="hs-identifier hs-var">unsafeDropErrors</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679539416"><span class="hs-identifier hs-var">parsed</span></a><span>
</span><a name="line-155"></a><span>                    </span><a href="Language.PlutusCore.TH.html#metavarSubstType"><span class="hs-identifier hs-var">metavarSubstType</span></a><span> </span><a href="#local-6989586621679539417"><span class="hs-identifier hs-var">runtimeTy</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679539414"><span class="hs-identifier hs-var">tyMetavars</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>          </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679539415"><span class="hs-identifier hs-var">quoted</span></a><span>
</span><a name="line-157"></a><span>      </span><span class="hs-special">|]</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">compileProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-160"></a><a name="compileProgram"><a href="Language.PlutusCore.TH.html#compileProgram"><span class="hs-identifier">compileProgram</span></a></a><span> </span><a name="local-6989586621679539419"><a href="#local-6989586621679539419"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Program"><span class="hs-identifier hs-var">Program</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679539420"><a href="#local-6989586621679539420"><span class="hs-identifier">compileTimeT</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.TH.html#eval"><span class="hs-identifier hs-var">eval</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusCore.Parser.html#parseProgram"><span class="hs-identifier hs-var">parseProgram</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PlutusPrelude.html#strToBs"><span class="hs-identifier hs-var">strToBs</span></a><span> </span><a href="#local-6989586621679539419"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-163"></a><span>        </span><a name="local-6989586621679539421"><a href="#local-6989586621679539421"><span class="hs-identifier">tyMetavars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#metavarMapType"><span class="hs-identifier hs-var">metavarMapType</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Subst.html#ftvTerm"><span class="hs-identifier hs-var">ftvTerm</span></a><span> </span><a href="#local-6989586621679539420"><span class="hs-identifier hs-var">compileTimeT</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>        </span><a name="local-6989586621679539422"><a href="#local-6989586621679539422"><span class="hs-identifier">termMetavars</span></a></a><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#metavarMapTerm"><span class="hs-identifier hs-var">metavarMapTerm</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Subst.html#fvTerm"><span class="hs-identifier hs-var">fvTerm</span></a><span> </span><a href="#local-6989586621679539420"><span class="hs-identifier hs-var">compileTimeT</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-special">[|</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-167"></a><span>            </span><span class="hs-identifier">quoted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Program"><span class="hs-identifier hs-type">Program</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>            </span><a name="local-6989586621679539423"><a href="#local-6989586621679539423"><span class="hs-identifier">quoted</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-169"></a><span>                </span><span class="hs-keyword">let</span><span>
</span><a name="line-170"></a><span>                    </span><span class="hs-comment">-- See note [Parsing and TH stages]</span><span>
</span><a name="line-171"></a><span>                    </span><span class="hs-identifier">parsed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Error.html#Error"><span class="hs-identifier hs-type">Error</span></a><span> </span><a href="Language.PlutusCore.Lexer.html#AlexPosn"><span class="hs-identifier hs-type">AlexPosn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Program"><span class="hs-identifier hs-type">Program</span></a><span> </span><a href="Language.PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a><span> </span><a href="Language.PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>                    </span><a name="local-6989586621679539424"><a href="#local-6989586621679539424"><span class="hs-identifier">parsed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.Parser.html#parseProgram"><span class="hs-identifier hs-var">parseProgram</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="PlutusPrelude.html#strToBs"><span class="hs-identifier hs-var">strToBs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539419"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-173"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-174"></a><span>                    </span><span class="hs-special">(</span><a href="Language.PlutusCore.Type.html#Program"><span class="hs-identifier hs-var">Program</span></a><span> </span><a name="local-6989586621679539425"><a href="#local-6989586621679539425"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679539426"><a href="#local-6989586621679539426"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679539427"><a href="#local-6989586621679539427"><span class="hs-identifier">runtimeT</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusCore.TH.html#unsafeDropErrors"><span class="hs-identifier hs-var">unsafeDropErrors</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679539424"><span class="hs-identifier hs-var">parsed</span></a><span>
</span><a name="line-175"></a><span>                    </span><a href="Language.PlutusCore.Type.html#Program"><span class="hs-identifier hs-var">Program</span></a><span> </span><a href="#local-6989586621679539425"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679539426"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusCore.TH.html#metavarSubstTerm"><span class="hs-identifier hs-var">metavarSubstTerm</span></a><span> </span><a href="#local-6989586621679539427"><span class="hs-identifier hs-var">runtimeT</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679539421"><span class="hs-identifier hs-var">tyMetavars</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679539422"><span class="hs-identifier hs-var">termMetavars</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679539423"><span class="hs-identifier hs-var">quoted</span></a><span>
</span><a name="line-177"></a><span>     </span><span class="hs-special">|]</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">-- | A quasiquoter for creating Plutus Core types.</span><span>
</span><a name="line-180"></a><span class="hs-identifier">plcType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">QuasiQuoter</span><span>
</span><a name="line-181"></a><a name="plcType"><a href="Language.PlutusCore.TH.html#plcType"><span class="hs-identifier">plcType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QuasiQuoter</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-identifier">quoteExp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#compileType"><span class="hs-identifier hs-var">compileType</span></a><span class="hs-special">,</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">quoteDec</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier">quotePat</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-identifier">quoteType</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span>
</span><a name="line-186"></a><span class="hs-special">}</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- | A quasiquoter for creating Plutus Core terms.</span><span>
</span><a name="line-189"></a><span class="hs-identifier">plcTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">QuasiQuoter</span><span>
</span><a name="line-190"></a><a name="plcTerm"><a href="Language.PlutusCore.TH.html#plcTerm"><span class="hs-identifier">plcTerm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QuasiQuoter</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-identifier">quoteExp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#compileTerm"><span class="hs-identifier hs-var">compileTerm</span></a><span class="hs-special">,</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-identifier">quoteDec</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier">quotePat</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-194"></a><span>    </span><span class="hs-identifier">quoteType</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span>
</span><a name="line-195"></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- | A quasiquoter for creating Plutus Core programs.</span><span>
</span><a name="line-198"></a><span class="hs-identifier">plcProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">QuasiQuoter</span><span>
</span><a name="line-199"></a><a name="plcProgram"><a href="Language.PlutusCore.TH.html#plcProgram"><span class="hs-identifier">plcProgram</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QuasiQuoter</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-identifier">quoteExp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusCore.TH.html#compileProgram"><span class="hs-identifier hs-var">compileProgram</span></a><span class="hs-special">,</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-identifier">quoteDec</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-202"></a><span>    </span><span class="hs-identifier">quotePat</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">quoteType</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Not implemented&quot;</span><span>
</span><a name="line-204"></a><span class="hs-special">}</span><span>
</span><a name="line-205"></a></pre></body></html>